<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- Favicon 使用絕對路徑 -->
    <link rel="icon" href="https://d4cheap16.github.io/VoiceoftheDEAD/zombie.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 社群分享標籤 (Open Graph) -->
    <title>Voice of the Dead</title>
    <meta name="description" content="Want to Survive? Speak!">
    <meta property="og:title" content="Speak your way out.">
    <meta property="og:description" content="Speak to excorcise.">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --horror-red: #8b0000;
            --horror-green: #00ff00;
            --horror-yellow: #ffff00;
            --ui-blue: #004488;
        }

        body {
            background-color: #000;
            color: #ccc;
            /* 全域英文字體設為 Press Start 2P，中文自動 fallback */
            font-family: 'Press Start 2P', 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        .pixel-font { font-family: 'Press Start 2P', cursive; }

        /* CRT 特效 */
        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 100;
            background-size: 100% 3px, 2px 100%;
            pointer-events: none;
        }

        @keyframes flicker {
            0% { opacity: 0.98; }
            5% { opacity: 0.95; }
            100% { opacity: 1; }
        }
        .flicker { animation: flicker 0.15s infinite; }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-3px, 3px); }
            50% { transform: translate(3px, -3px); }
            75% { transform: translate(-3px, -3px); }
        }
        .shake-anim { animation: shake 0.3s; }

        .game-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px; 
            height: 100dvh;
            background: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 2px solid #222;
            border-right: 2px solid #222;
        }

        /* 2/3 遊戲畫面 */
        .canvas-container {
            width: 100%;
            height: 67%;
            position: relative;
            border-bottom: 2px solid var(--horror-red);
            overflow: hidden;
        }

        #game-canvas {
            image-rendering: pixelated;
            background: radial-gradient(circle, #151515 0%, #000 100%);
            width: 100%;
            height: 100%;
        }

        /* 1/3 UI 面板 */
        .ui-panel {
            height: 33%;
            width: 100%;
            background: #050505;
            padding: 12px 15px;
            display: grid;
            grid-template-rows: auto 1fr auto; 
            gap: 10px;
            z-index: 50;
            box-sizing: border-box;
        }

        .btn {
            background: #0a0a0a;
            border: 1px solid #444;
            color: #ccc;
            padding: 10px;
            cursor: pointer;
            font-size: 8px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', cursive;
        }
        .btn:active { background: #333; color: #fff; }

        select, input {
            background: #000;
            border: 1px solid #444;
            color: #0f0;
            padding: 12px;
            font-size: 10px;
            margin: 4px 0;
            width: 100%;
            border-radius: 2px;
            font-family: 'Press Start 2P', 'Noto Sans TC', sans-serif;
        }

        .overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }

        .active-diff { border-color: #fff !important; background: #222 !important; color: #fff !important; }

        #status-label {
            font-size: 10px;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .status-fine { color: var(--horror-green); }
        .status-caution { color: var(--horror-yellow); }
        .status-danger { color: var(--horror-red); }

        .banner-box {
            width: 100%;
            aspect-ratio: 1480 / 450;
            background: #000;
            margin-bottom: 15px;
            border: 1px solid #333;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .banner-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
        }

        #reward-toast {
            position: absolute;
            top: 20%;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 100;
            transition: all 0.5s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .toast-active { opacity: 1 !important; transform: translateY(0) !important; }

        #flash-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 67%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 120;
        }

        #current-word-ui {
            background: rgba(20, 20, 20, 0.8);
            padding: 8px;
            border-radius: 4px;
            min-height: 3em;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #333;
        }
    </style>
</head>
<body class="crt">

<div class="game-wrapper" id="main-container">
    <div id="reward-toast" class="pixel-font text-white text-[12px]"></div>
    <div id="flash-overlay"></div>

    <!-- 1. 任務選擇畫面 -->
    <div id="mission-screen" class="overlay-screen">
        <div class="banner-box">
            <img src="https://d4cheap16.github.io/VoiceoftheDEAD/indexbanner.png" alt="Banner" onerror="this.style.display='none'">
        </div>
        <h1 class="pixel-font text-md mb-4 flicker" style="color:#ccc">SELECT SECTOR</h1>
        <div class="bg-black p-4 border border-zinc-800 w-full max-w-sm flex flex-col items-center">
            <div class="w-full mb-4">
                <p class="text-[7px] text-zinc-600 mb-2 pixel-font uppercase">Data Volume</p>
                <div class="grid grid-cols-5 gap-1">
                    <button onclick="selectBook(1)" class="btn book-btn" id="b1">I</button>
                    <button onclick="selectBook(2)" class="btn book-btn" id="b2">II</button>
                    <button onclick="selectBook(3)" class="btn book-btn" id="b3">III</button>
                    <button onclick="selectBook(4)" class="btn book-btn active-diff" id="b4">IV</button>
                    <button onclick="selectBook(5)" class="btn book-btn" id="b5">V</button>
                </div>
            </div>
            <div class="w-full mb-4">
                <p class="text-[7px] text-zinc-600 mb-2 pixel-font uppercase">Sector Unit</p>
                <div class="grid grid-cols-3 gap-1">
                    <button onclick="selectLesson(1)" class="btn lesson-btn active-diff" id="l1">1</button>
                    <button onclick="selectLesson(2)" class="btn lesson-btn" id="l2">2</button>
                    <button onclick="selectLesson(3)" class="btn lesson-btn" id="l3">3</button>
                    <button onclick="selectLesson(4)" class="btn lesson-btn" id="l4">4</button>
                    <button onclick="selectLesson(5)" class="btn lesson-btn" id="l5">5</button>
                    <button onclick="selectLesson(6)" class="btn lesson-btn" id="l6">6</button>
                    <button onclick="selectLesson(7)" class="btn lesson-btn" id="l7">7</button>
                    <button onclick="selectLesson(8)" class="btn lesson-btn" id="l8">8</button>
                    <button onclick="selectLesson(9)" class="btn lesson-btn" id="l9">9</button>
                </div>
            </div>
            <div id="mission-status" class="text-[7px] pixel-font text-zinc-500 mb-4 h-4 uppercase">...system idle...</div>
            <button onclick="confirmMission()" id="confirm-mission-btn" class="btn w-full py-4 text-white bg-blue-900 border-blue-500" disabled>CONFIRM</button>
        </div>
    </div>

    <!-- 2. 登錄畫面 -->
    <div id="login-screen" class="overlay-screen hidden">
        <div class="banner-box">
            <img src="https://d4cheap16.github.io/VoiceoftheDEAD/missionbanner.png" alt="Banner" onerror="this.style.display='none'">
        </div>
        <h1 class="pixel-font text-sm mb-4 text-blue-500 uppercase" id="selected-mission-title">MISSION ID</h1>
        <div class="flex flex-col items-center bg-black p-4 border border-zinc-800 w-full max-w-sm">
            <p class="text-[7px] text-zinc-600 mb-4 pixel-font uppercase">Member Registration</p>
            <div class="flex gap-1 w-full">
                <select id="select-grade">
                    <option value="高一">10</option>
                    <option value="高二">11</option>
                    <option value="高三">12</option>
                </select>
                <select id="select-class">
                    <option value="知足">知足</option>
                    <option value="感恩">感恩</option>
                    <option value="善解">善解</option>
                    <option value="包容">包容</option>
                    <option value="大愛">大愛</option>
                    <option value="外校">外校</option>
                </select>
            </div>
            <input type="number" id="input-no" placeholder="NUMBER" pattern="\d*">
            <input type="text" id="input-name" placeholder="NAME">
            <div class="mt-4 w-full">
                <p class="text-[7px] text-zinc-600 mb-2 pixel-font uppercase">Difficulty</p>
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="setDifficulty(0.7, 'Rookie')" class="btn diff-btn" id="diff-rookie">Rookie</button>
                    <button onclick="setDifficulty(1.0, 'Veteran')" class="btn diff-btn active-diff" id="diff-veteran">Veteran</button>
                    <button onclick="setDifficulty(1.5, 'Nightmare')" class="btn diff-btn" id="diff-nightmare">Nightmare</button>
                    <button onclick="setDifficulty(2.5, 'NO HOPE')" class="btn diff-btn text-red-500" id="diff-nohope">NO HOPE</button>
                </div>
            </div>
            <div class="flex gap-2 w-full mt-6">
                 <button onclick="backToMissionSelect()" class="btn w-1/3 bg-zinc-900">BACK</button>
                 <button id="start-btn" onclick="handleAuth()" class="btn w-2/3 bg-red-950 border-red-700 text-red-500">INITIATE</button>
            </div>
        </div>
    </div>

    <!-- 3. ALL CLEAR -->
    <div id="win-screen" class="overlay-screen hidden">
        <h1 id="win-title" class="text-green-500 pixel-font text-xl mb-4 flicker uppercase">All Clear</h1>
        <div class="bg-black border border-green-900 p-6 mb-8 w-full max-w-xs text-center text-[10px]">
            <p id="win-score" class="pixel-font text-md text-yellow-500 mb-2 uppercase">Score: 0</p>
            <p id="win-detail" class="text-zinc-500 uppercase mt-2">Area Secured.</p>
        </div>
        <button onclick="retreatToMenu()" class="btn w-full max-w-xs py-4 uppercase">Return Base</button>
    </div>

    <!-- Game Over -->
    <div id="game-over-screen" class="overlay-screen hidden">
        <h2 class="pixel-font text-red-700 text-xl mb-6 flicker uppercase">You are dead.</h2>
        <p id="final-score-display" class="pixel-font text-[8px] text-zinc-500 mb-8 uppercase"></p>
        <div class="flex flex-col gap-3 w-full max-w-xs">
            <button onclick="restartCurrentGame()" class="btn w-full py-4 bg-red-950 text-red-500 border-red-700 uppercase">Retry</button>
            <button onclick="retreatToMenu()" class="btn w-full py-4 uppercase">Give Up</button>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="admin-screen" class="overlay-screen hidden flex flex-col">
        <h2 class="text-blue-600 mb-4 uppercase">Archive Data</h2>
        <div class="admin-table-container">
            <table class="w-full text-left">
                <thead class="bg-zinc-900 sticky top-0">
                    <tr><th>Class</th><th>No</th><th>Name</th><th>Score</th><th>Diff</th></tr>
                </thead>
                <tbody id="records-body"></tbody>
            </table>
        </div>
        <div class="p-4 bg-zinc-900 w-full border-t border-zinc-800">
            <button onclick="location.reload()" class="btn w-full py-3 bg-blue-950 border-blue-700 text-white uppercase">Close Terminal</button>
        </div>
    </div>

    <!-- Pause Screen -->
    <div id="pause-screen" class="overlay-screen hidden">
        <h2 class="pixel-font text-zinc-500 text-lg mb-4 uppercase">Paused</h2>
        <div id="target-word-hint" class="text-sm text-white font-bold mb-10 border-y border-zinc-800 py-6 w-full text-center tracking-widest uppercase">---</div>
        <div class="flex flex-col gap-4 w-full max-w-xs px-4">
            <button onclick="speakTarget()" class="btn bg-blue-900 py-4 uppercase">Play Voice</button>
            <button onclick="resumeGame()" class="btn bg-green-950 py-4 uppercase">Resume</button>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- 下方 UI Panel -->
    <div class="ui-panel">
        <div class="flex justify-between items-end border-b border-zinc-800 pb-2">
            <div class="flex flex-col">
                <div id="status-label" class="pixel-font status-fine">FINE</div>
                <div id="score-display" class="text-[7px] text-zinc-600 pixel-font mt-1">000000</div>
            </div>
            <div id="combo-display" class="pixel-font opacity-0 transition-opacity">0 COMBO</div>
            <div id="level-progress-ui" class="text-[6px] text-zinc-700 pixel-font mb-1 uppercase">Sec 1: 0/10</div>
        </div>
        <div class="flex items-center justify-center">
            <div id="current-word-ui" class="text-[9px] md:text-[11px] text-zinc-300 font-bold text-center leading-tight uppercase tracking-widest">AWAITING TARGET...</div>
        </div>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="togglePause()" class="btn !py-3 uppercase">Pause</button>
            <button onclick="retreatToMenu()" class="btn !py-3 bg-zinc-900 uppercase">Retreat</button>
        </div>
    </div>

    <div id="blood-splatter" class="fixed inset-0 pointer-events-none bg-red-900/30 opacity-0 transition-opacity duration-300 z-[150]"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKiz17S_mjAEcat-oT0EDVnvKxhTzxQe8",
        authDomain: "voiceofthedead.firebaseapp.com",
        projectId: "voiceofthedead",
        storageBucket: "voiceofthedead.firebasestorage.app",
        messagingSenderId: "757378314086",
        appId: "1:757378314086:web:aa598f79e28e3cb6a122a7"
    };

    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        window.fbase = { db, auth, setDoc, doc, collection, serverTimestamp, getDocs };
        signInAnonymously(auth);
    } catch (e) { console.error(e); }
    window.appId = 'voice-shooter-101';
</script>

<script>
    const ADMIN_NAME = "AdaWong";
    let selectedBook = 4; 
    let selectedLesson = 1; 
    let currentBookData = {}; 
    let currentLessonData = null; 
    let wakeLock = null; // 用於儲存螢幕鎖定物件

    // 防止手機螢幕自動關閉
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock is active');
            }
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    }

    function releaseWakeLock() {
        if (wakeLock !== null) {
            wakeLock.release();
            wakeLock = null;
            console.log('Wake Lock released');
        }
    }

    async function loadBookData(bookNum) {
        const statusEl = document.getElementById('mission-status');
        const btn = document.getElementById('confirm-mission-btn');
        statusEl.innerText = `ACCESSING ARCHIVE ${bookNum}...`;
        try {
            const response = await fetch(`book${bookNum}.json`);
            if (!response.ok) throw new Error();
            currentBookData = await response.json();
            statusEl.innerText = `ARCHIVE ${bookNum} READY`;
            checkDataAvailability();
        } catch (error) {
            currentBookData = {}; 
            statusEl.innerText = `ACCESS DENIED`;
            checkDataAvailability();
        }
    }

    function selectBook(n) {
        selectedBook = n;
        document.querySelectorAll('.book-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`b${n}`).classList.add('active-diff');
        loadBookData(n);
    }

    function selectLesson(n) {
        selectedLesson = n;
        document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`l${n}`).classList.add('active-diff');
        checkDataAvailability();
    }

    function checkDataAvailability() {
        const key = `L${selectedLesson}`;
        const statusEl = document.getElementById('mission-status');
        const btn = document.getElementById('confirm-mission-btn');
        if (currentBookData && currentBookData[key]) {
            statusEl.innerText = `READY: ${currentBookData[key].title.toUpperCase()}`;
            btn.disabled = false;
        } else {
            btn.disabled = true;
            statusEl.innerText = "NO DATA FOUND";
        }
    }

    loadBookData(4);

    function confirmMission() {
        const key = `L${selectedLesson}`;
        currentLessonData = currentBookData[key];
        document.getElementById('mission-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('selected-mission-title').innerText = currentLessonData.title.toUpperCase();
    }

    function backToMissionSelect() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('mission-screen').classList.remove('hidden');
    }

    function retreatToMenu() {
        state.gameActive = false;
        releaseWakeLock(); // 退出時釋放鎖定
        if (recognition) recognition.stop();
        document.getElementById('win-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('pause-screen').classList.add('hidden');
        document.getElementById('mission-screen').classList.remove('hidden');
    }

    function restartCurrentGame() {
        document.getElementById('game-over-screen').classList.add('hidden');
        startGame();
    }

    // --- Core Game Logic ---
    let state = {
        score: 0, hp: 5, level: 1, levelKills: 0, combo: 0,
        damageTaken: 0,
        isPaused: false, gameActive: false,
        isFlashActive: false,
        enemies: [], player: { class: "", no: "", name: "" },
        spawnTimer: 0, isFirstSpawn: true,
        difficultyMultiplier: 1.0, difficultyName: "Veteran"
    };

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const bloodOverlay = document.getElementById('blood-splatter');
    const flashOverlay = document.getElementById('flash-overlay');
    const mainContainer = document.getElementById('main-container');

    function getLevelGoal(lv) {
        const base = lv === 1 ? 10 : 5;
        return Math.floor(base * state.difficultyMultiplier);
    }

    function handleResize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', handleResize);
    handleResize();

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        recognition.onresult = (event) => {
            if (state.isPaused || !state.gameActive) return;
            let transcript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript.toUpperCase();
            }
            
            const cleanText = (t) => t.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s+/g, ' ').trim();
            const cleanTranscript = cleanText(transcript);

            state.enemies.forEach((enemy, index) => {
                if (!enemy.isDying) {
                    const cleanWord = cleanText(enemy.word.toUpperCase());
                    if (cleanTranscript.includes(cleanWord)) killEnemy(index);
                }
            });
        };
        recognition.onend = () => { if (state.gameActive && !state.isPaused) try { recognition.start(); } catch(e) {} };
    }

    class Enemy {
        constructor(word, lv, isElite = false, forceClose = false) {
            this.word = word;
            this.z = forceClose ? 0.45 : (Math.random() * 0.2); 
            
            const wordCount = word.split(' ').length;
            const sentenceSlowdown = wordCount > 3 ? 0.7 : 1.0; 

            const stageFactor = state.level === 2 ? 0.8 : 1.1; 
            let speedRoll = Math.random();
            let speedBase = 0.0007; // 稍微調快基礎速度
            if (speedRoll > 0.95) speedBase = 0.0028; 
            else if (speedRoll > 0.75) speedBase = 0.0014; 
            
            this.speed = (speedBase + (Math.random() * 0.0005)) * state.difficultyMultiplier * (isElite ? 0.85 : 1) * stageFactor * sentenceSlowdown;
            this.x = (Math.random() - 0.5) * 360; 
            this.y = (Math.random() - 0.5) * 60;
            this.isDying = false;
            this.opacity = 0;
            this.isElite = isElite;
            // 菁英怪隨機詭異配色
            this.cSkin = isElite ? (Math.random() > 0.5 ? '#4a008b' : '#005f5f') : (Math.random() > 0.5 ? '#3d5c31' : '#567d46');
            this.cShirt = isElite ? (Math.random() > 0.5 ? '#ffd700' : '#ff00ff') : (Math.random() > 0.5 ? '#4a4a4a' : '#2e2e2e');
        }
        update() {
            if (this.isDying) return (this.opacity -= 0.15) <= 0;
            if (!state.isFlashActive) { this.z += this.speed; }
            if (this.opacity < 1) this.opacity += 0.1;
            return this.z >= 1;
        }
        draw() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const w = rect.width; const h = rect.height;
            
            // 強化壓迫感：增加基礎 size 與 scaling 常數
            const baseSize = this.isElite ? 22 : 12;
            const size = baseSize + (Math.pow(this.z, 2.0) * 350); 
            
            const xPos = w / 2 + (this.x * this.z);
            const yPos = h / 2 + (this.y * this.z) + (this.z * (h * 0.4));
            
            ctx.save();
            ctx.globalAlpha = this.opacity;
            const depthBrightness = 0.2 + (Math.pow(this.z, 0.7) * 0.8);
            ctx.filter = `brightness(${depthBrightness})`;
            
            // 菁英怪氣場特效
            if (this.isElite) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = (Date.now() % 400 < 200) ? 'purple' : 'cyan';
            }

            // 身體 (菁英怪更寬)
            const bodyW = this.isElite ? size*0.8 : size*0.6;
            ctx.fillStyle = this.cShirt;
            ctx.fillRect(xPos - bodyW/2, yPos - size*0.7, bodyW, size*0.6); 
            
            // 頭部 (菁英怪造型誇張：更尖或更高)
            ctx.fillStyle = this.cSkin;
            if (this.isElite) {
                // 尖頭形狀
                ctx.beginPath();
                ctx.moveTo(xPos - size*0.25, yPos - size*0.7);
                ctx.lineTo(xPos, yPos - size*1.3);
                ctx.lineTo(xPos + size*0.25, yPos - size*0.7);
                ctx.fill();
            } else {
                ctx.fillRect(xPos - size*0.2, yPos - size*1.1, size*0.4, size*0.4); 
            }
            
            // 眼睛 (閃爍感)
            ctx.fillStyle = this.isElite ? ((Date.now() % 200 < 100) ? 'white' : 'cyan') : 'red';
            ctx.fillRect(xPos - size*0.12, yPos - size*1.0, size*0.06, size*0.06);
            ctx.fillRect(xPos + size*0.06, yPos - size*1.0, size*0.06, size*0.06);

            // 文字 UI 優化
            const fontSize = Math.max(9, Math.min(12, size/7));
            ctx.font = `bold ${fontSize}px 'Press Start 2P'`;
            const textWidth = ctx.measureText(this.word).width;
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(xPos - (textWidth/2) - 5, yPos - size*1.4 - fontSize, textWidth + 10, fontSize + 8);
            ctx.fillStyle = this.isElite ? 'gold' : '#fff';
            ctx.textAlign = 'center';
            ctx.shadowBlur = 4; ctx.shadowColor = 'red';
            
            if (this.word.length > 20) {
                const mid = Math.floor(this.word.length / 2);
                const spaceIdx = this.word.lastIndexOf(' ', mid);
                const line1 = this.word.substring(0, spaceIdx);
                const line2 = this.word.substring(spaceIdx + 1);
                ctx.fillText(line1, xPos, yPos - size*1.5);
                ctx.fillText(line2, xPos, yPos - size*1.3);
            } else {
                ctx.fillText(this.word, xPos, yPos - size*1.4);
            }
            
            ctx.restore();
        }
    }

    function setDifficulty(val, name) {
        state.difficultyMultiplier = val;
        state.difficultyName = name;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active-diff'));
        if (val === 0.7) document.getElementById('diff-rookie').classList.add('active-diff');
        if (val === 1.0) document.getElementById('diff-veteran').classList.add('active-diff');
        if (val === 1.5) document.getElementById('diff-nightmare').classList.add('active-diff');
        if (val === 2.5) document.getElementById('diff-nohope').classList.add('active-diff');
    }

    function spawnLogic() {
        if (!state.gameActive || state.isPaused || state.isFlashActive) return;
        const spawnInterval = 1500 / state.difficultyMultiplier;
        if ((state.isFirstSpawn && state.enemies.length === 0) || (state.enemies.length < 4 && Date.now() - state.spawnTimer > spawnInterval)) {
            const list = currentLessonData.stages[state.level.toString()];
            const word = list[Math.floor(Math.random() * list.length)];
            if (!state.enemies.some(e => e.word === word)) {
                let newEnemy = new Enemy(word, state.level, Math.random() < 0.2, state.isFirstSpawn);
                let attempts = 0;
                while (attempts < 8 && state.enemies.some(e => Math.abs(e.x - newEnemy.x) < 90 && Math.abs(e.z - newEnemy.z) < 0.15)) {
                    newEnemy.x = (Math.random() - 0.5) * 360;
                    attempts++;
                }
                state.enemies.push(newEnemy);
                state.spawnTimer = Date.now();
                state.isFirstSpawn = false;
            }
        }
    }

    function triggerReward() {
        const rewards = ["RECOVER (+1 HP)", "FLASH (Freeze 3s)", "ELIMINATE (Remove 1)"];
        const roll = Math.floor(Math.random() * rewards.length);
        const toast = document.getElementById('reward-toast');
        toast.innerText = `REWARD: ${rewards[roll]}`;
        toast.classList.add('toast-active');
        setTimeout(() => toast.classList.remove('toast-active'), 2000);

        if (roll === 0) state.hp = Math.min(5, state.hp + 1);
        else if (roll === 1) {
            state.isFlashActive = true;
            flashOverlay.style.opacity = "0.7";
            setTimeout(() => flashOverlay.style.opacity = "0", 300);
            setTimeout(() => { state.isFlashActive = false; }, 3000);
        } else if (roll === 2) {
            const activeEnemies = state.enemies.filter(e => !e.isDying);
            if (activeEnemies.length > 0) activeEnemies[Math.floor(Math.random() * activeEnemies.length)].isDying = true;
        }
        updateUI();
    }

    function killEnemy(idx) {
        if (!state.enemies[idx]) return;
        state.enemies[idx].isDying = true;
        state.combo++;
        if (state.combo > 0 && state.combo % 10 === 0) triggerReward();
        
        const comboBonus = Math.floor(state.combo / 5) * 50;
        state.score += ((state.enemies[idx].isElite ? 600 : 100) + comboBonus) * state.level;
        state.levelKills++;
        
        const goal = getLevelGoal(state.level);
        if (state.levelKills >= goal) {
            if (state.level < 2) { state.level++; state.levelKills = 0; state.enemies = []; }
            else { winGame(); }
        }
        updateUI();
    }

    function triggerDamage() {
        state.hp--; 
        state.damageTaken++;
        state.combo = 0; 
        bloodOverlay.style.opacity = "1";
        mainContainer.classList.add('shake-anim');
        setTimeout(() => { bloodOverlay.style.opacity = "0"; mainContainer.classList.remove('shake-anim'); }, 300);
        updateUI(); 
        if (state.hp <= 0) endGame();
    }

    function updateUI() {
        const statusLabel = document.getElementById('status-label');
        if (state.hp >= 4) { statusLabel.innerText = "FINE"; statusLabel.className = "pixel-font status-fine"; }
        else if (state.hp >= 2) { statusLabel.innerText = "CAUTION"; statusLabel.className = "pixel-font status-caution"; }
        else { statusLabel.innerText = "DANGER"; statusLabel.className = "pixel-font status-danger"; }

        const comboEl = document.getElementById('combo-display');
        if (state.combo >= 2) { comboEl.innerText = `${state.combo} COMBO`; comboEl.style.opacity = "1"; }
        else { comboEl.style.opacity = "0"; }

        document.getElementById('score-display').innerText = state.score.toString().padStart(6, '0');
        document.getElementById('level-progress-ui').innerText = `SEC ${state.level}: ${state.levelKills}/${getLevelGoal(state.level)}`;
        
        const target = state.enemies.filter(e => !e.isDying).sort((a,b) => b.z - a.z)[0];
        const uiWord = document.getElementById('current-word-ui');
        if (target) {
            uiWord.innerText = target.word.toUpperCase();
            uiWord.classList.add('text-white');
            uiWord.classList.remove('text-zinc-600');
        } else {
            uiWord.innerText = "AWAITING TARGET...";
            uiWord.classList.remove('text-white');
            uiWord.classList.add('text-zinc-600');
        }
    }

    function gameLoop() {
        if (!state.gameActive || state.isPaused) return;
        const rect = canvas.parentElement.getBoundingClientRect();
        const w = rect.width; const h = rect.height;
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
        
        ctx.strokeStyle = '#0e0e0e'; ctx.lineWidth = 1; ctx.beginPath();
        for(let i=0; i<16; i++) { ctx.moveTo(w/2, h/2); ctx.lineTo(i * (w/15), h); }
        ctx.stroke();
        
        spawnLogic();
        state.enemies.sort((a, b) => a.z - b.z);
        for (let i = state.enemies.length - 1; i >= 0; i--) {
            const enemy = state.enemies[i];
            if (enemy.update()) {
                if (!enemy.isDying) { state.enemies.splice(i, 1); triggerDamage(); }
                else { state.enemies.splice(i, 1); }
            } else { enemy.draw(); }
        }
        updateUI();
        requestAnimationFrame(gameLoop);
    }

    function handleAuth() {
        const nameInput = document.getElementById('input-name').value.trim();
        if (nameInput === ADMIN_NAME) { showAdminDashboard(); return; }
        const no = document.getElementById('input-no').value.trim();
        const grade = document.getElementById('select-grade').value;
        const cls = document.getElementById('select-class').value;
        if (!no || !nameInput) return;
        state.player = { class: `${grade}${cls}`, no: no, name: nameInput };
        document.getElementById('login-screen').classList.add('hidden');
        startGame();
    }

    async function showAdminDashboard() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-screen').classList.remove('hidden');
        const body = document.getElementById('records-body');
        body.innerHTML = "<tr><td colspan='5' class='p-8 text-center text-zinc-500'>ACCESSING...</td></tr>";
        try {
            const { db, appId, collection, getDocs } = window.fbase;
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
            let res = []; snap.forEach(d => res.push(d.data()));
            res.sort((a,b) => a.class.localeCompare(b.class) || a.no - b.no);
            body.innerHTML = "";
            res.forEach(d => {
                body.insertAdjacentHTML('beforeend', `<tr><td class="font-bold text-blue-400">${d.class}</td><td>${d.no}</td><td class="text-zinc-200">${d.name}</td><td class="text-green-500 font-bold">${d.score}</td><td class="text-zinc-600 text-[10px]">${d.difficulty || 'Normal'}</td></tr>`);
            });
        } catch (e) { body.innerHTML = "<tr><td colspan='5' class='p-8 text-center text-red-700'>ERROR</td></tr>"; }
    }

    function startGame() {
        state.gameActive = true; 
        state.hp = 5; state.score = 0; state.level = 1; state.levelKills = 0; state.combo = 0; state.damageTaken = 0; state.enemies = []; state.isFirstSpawn = true;
        
        requestWakeLock(); // 請求螢幕常亮鎖定
        
        updateUI(); handleResize(); 
        if (recognition) { try { recognition.start(); } catch(e) {} } 
        gameLoop();
    }

    async function syncData() {
        try {
            const { db, appId, setDoc, doc, serverTimestamp } = window.fbase;
            const rid = `${state.player.class}_${state.player.no}_${Date.now()}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', rid), {
                ...state.player, score: state.score, difficulty: state.difficultyName, timestamp: serverTimestamp()
            });
        } catch (e) {}
    }

    function winGame() { 
        state.gameActive = false; 
        releaseWakeLock(); // 釋放鎖定
        const winTitle = document.getElementById('win-title');
        const winDetail = document.getElementById('win-detail');
        if (state.damageTaken === 0) {
            winTitle.innerText = "PERFECT CLEAR";
            winTitle.className = "text-yellow-500 pixel-font text-xl mb-4 flicker uppercase";
            winDetail.innerText = "GODLIKE SURVIVOR. NO DAMAGE TAKEN.";
            winDetail.className = "text-yellow-600 uppercase mt-2 font-bold";
        } else {
            winTitle.innerText = "ALL CLEAR";
            winTitle.className = "text-green-500 pixel-font text-xl mb-4 flicker uppercase";
            winDetail.innerText = "AREA SECURED.";
            winDetail.className = "text-zinc-500 uppercase mt-2";
        }
        document.getElementById('win-screen').classList.remove('hidden'); 
        document.getElementById('win-score').innerText = `SCORE: ${state.score}`; 
        syncData(); 
    }
    function endGame() { 
        state.gameActive = false; 
        releaseWakeLock(); // 釋放鎖定
        document.getElementById('game-over-screen').classList.remove('hidden'); 
        document.getElementById('final-score-display').innerText = `SCORE: ${state.score}`; 
        syncData(); 
    }
    
    function togglePause() { 
        if (!state.gameActive) return;
        state.isPaused = !state.isPaused; 
        document.getElementById('pause-screen').classList.toggle('hidden');
        if (state.isPaused) { 
            releaseWakeLock(); // 暫停時釋放鎖定
            if (recognition) recognition.stop(); 
            if (state.enemies[0]) document.getElementById('target-word-hint').innerText = state.enemies[0].word.toUpperCase(); 
        }
        else { 
            requestWakeLock(); // 恢復時重新鎖定
            if (recognition) try { recognition.start(); } catch(e) {} 
            gameLoop(); 
        }
    }
    function resumeGame() { togglePause(); }
    function speakTarget() { const u = new SpeechSynthesisUtterance(document.getElementById('target-word-hint').innerText); u.lang = 'en-US'; speechSynthesis.speak(u); }
</script>
</body>
</html>
