<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- Favicon 使用絕對路徑 -->
    <link rel="icon" href="https://voiceofthedead.firebaseapp.com/zombie.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 社群分享標籤 (Open Graph) -->
    <title>Voice of the Dead</title>
    <meta name="description" content="Want to Survive? Speak!">
    <meta property="og:title" content="Speak your way out.">
    <meta property="og:description" content="Speak to excorcise.">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --horror-red: #8b0000;
            --horror-green: #00ff00;
            --horror-yellow: #ffff00;
            --ui-blue: #004488;
        }

        body {
            background-color: #000;
            color: #ccc;
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        .pixel-font { font-family: 'Press Start 2P', cursive; }

        /* CRT 掃描線與靜電特效 */
        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 100;
            background-size: 100% 3px, 2px 100%;
            pointer-events: none;
        }

        @keyframes flicker {
            0% { opacity: 0.98; }
            5% { opacity: 0.95; }
            100% { opacity: 1; }
        }
        .flicker { animation: flicker 0.15s infinite; }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-3px, 3px); }
            50% { transform: translate(3px, -3px); }
            75% { transform: translate(-3px, -3px); }
        }
        .shake-anim { animation: shake 0.3s; }

        .game-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px; 
            height: 100dvh;
            background: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 2px solid #222;
            border-right: 2px solid #222;
        }

        .canvas-container {
            width: 100%;
            height: 67%;
            position: relative;
            border-bottom: 2px solid var(--horror-red);
            overflow: hidden;
        }

        #game-canvas {
            image-rendering: pixelated;
            background: radial-gradient(circle, #151515 0%, #000 95%);
            width: 100%;
            height: 100%;
        }

        .ui-panel {
            height: 33%;
            width: 100%;
            background: #050505;
            padding: 12px 15px;
            display: grid;
            grid-template-rows: auto 1fr auto; 
            gap: 10px;
            z-index: 50;
            box-sizing: border-box;
        }

        .btn {
            background: #0a0a0a;
            border: 1px solid #444;
            color: #ccc;
            padding: 10px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active { background: #333; color: #fff; }

        select, input {
            background: #000;
            border: 1px solid #444;
            color: #0f0;
            padding: 12px;
            font-size: 14px;
            margin: 4px 0;
            width: 100%;
            border-radius: 2px;
        }

        .overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }

        .active-diff { border-color: #fff !important; background: #222 !important; color: #fff !important; }

        #status-label {
            font-size: 12px;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .status-fine { color: var(--horror-green); }
        .status-caution { color: var(--horror-yellow); }
        .status-danger { color: var(--horror-red); }
        
        /* 管理員表格樣式 */
        #records-body tr:nth-child(even) { background: #080808; }
        .admin-table-container { max-height: 60vh; width: 100%; overflow-y: auto; border: 1px solid #333; }
    </style>
</head>
<body class="crt">

<div class="game-wrapper" id="main-container">
    
    <!-- 1. 任務選擇畫面 -->
    <div id="mission-screen" class="overlay-screen">
        <h1 class="pixel-font text-lg mb-6 flicker" style="color:#ccc">SELECT SECTOR</h1>
        
        <div class="bg-black p-4 border border-zinc-800 w-full max-w-sm flex flex-col items-center">
            <div class="w-full mb-4">
                <p class="text-[8px] text-zinc-600 mb-2 pixel-font">DATA VOLUME</p>
                <div class="grid grid-cols-5 gap-1">
                    <button onclick="selectBook(1)" class="btn pixel-font book-btn" id="b1">I</button>
                    <button onclick="selectBook(2)" class="btn pixel-font book-btn" id="b2">II</button>
                    <button onclick="selectBook(3)" class="btn pixel-font book-btn" id="b3">III</button>
                    <button onclick="selectBook(4)" class="btn pixel-font book-btn active-diff" id="b4">IV</button>
                    <button onclick="selectBook(5)" class="btn pixel-font book-btn" id="b5">V</button>
                </div>
            </div>

            <div class="w-full mb-4">
                <p class="text-[8px] text-zinc-600 mb-2 pixel-font">SECTOR UNIT</p>
                <div class="grid grid-cols-3 gap-1">
                    <button onclick="selectLesson(1)" class="btn pixel-font lesson-btn active-diff" id="l1">1</button>
                    <button onclick="selectLesson(2)" class="btn pixel-font lesson-btn" id="l2">2</button>
                    <button onclick="selectLesson(3)" class="btn pixel-font lesson-btn" id="l3">3</button>
                    <button onclick="selectLesson(4)" class="btn pixel-font lesson-btn" id="l4">4</button>
                    <button onclick="selectLesson(5)" class="btn pixel-font lesson-btn" id="l5">5</button>
                    <button onclick="selectLesson(6)" class="btn pixel-font lesson-btn" id="l6">6</button>
                    <button onclick="selectLesson(7)" class="btn pixel-font lesson-btn" id="l7">7</button>
                    <button onclick="selectLesson(8)" class="btn pixel-font lesson-btn" id="l8">8</button>
                    <button onclick="selectLesson(9)" class="btn pixel-font lesson-btn" id="l9">9</button>
                </div>
            </div>

            <div id="mission-status" class="text-[8px] pixel-font text-zinc-500 mb-4 h-4">...SYSTEM IDLE...</div>
            <button onclick="confirmMission()" id="confirm-mission-btn" class="btn w-full py-4 pixel-font text-white bg-blue-900 border-blue-500" disabled>CONFIRM</button>
        </div>
    </div>

    <!-- 2. 登錄畫面 -->
    <div id="login-screen" class="overlay-screen hidden">
        <h1 class="pixel-font text-md mb-4 text-blue-500" id="selected-mission-title">MISSION ID: UNKNOWN</h1>
        <div class="flex flex-col items-center bg-black p-4 border border-zinc-800 w-full max-w-sm">
            <p class="text-[8px] text-zinc-600 mb-4 pixel-font uppercase">Member Registration</p>
            
            <div class="flex gap-1 w-full">
                <select id="select-grade">
                    <option value="高一">10</option>
                    <option value="高二">11</option>
                    <option value="高三">12</option>
                </select>
                <select id="select-class">
                    <option value="知足">知足</option>
                    <option value="感恩">感恩</option>
                    <option value="善解">善解</option>
                    <option value="包容">包容</option>
                    <option value="大愛">大愛</option>
                    <option value="外校">外校</option>
                </select>
            </div>
            
            <input type="number" id="input-no" placeholder="NUMBER" pattern="\d*">
            <input type="text" id="input-name" placeholder="NAME">
            
            <div class="mt-4 w-full">
                <p class="text-[8px] text-zinc-600 mb-2 pixel-font">DIFFICULTY</p>
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="setDifficulty(0.7, 'Rookie')" class="btn diff-btn pixel-font" id="diff-rookie">Rookie</button>
                    <button onclick="setDifficulty(1.0, 'Veteran')" class="btn diff-btn active-diff pixel-font" id="diff-veteran">Veteran</button>
                    <button onclick="setDifficulty(1.5, 'Nightmare')" class="btn diff-btn pixel-font" id="diff-nightmare">Nightmare</button>
                    <button onclick="setDifficulty(2.5, 'NO HOPE')" class="btn diff-btn text-red-500 pixel-font" id="diff-nohope">NO HOPE</button>
                </div>
            </div>

            <div class="flex gap-2 w-full mt-6">
                 <button onclick="backToMissionSelect()" class="btn w-1/3 pixel-font bg-zinc-900">BACK</button>
                 <button id="start-btn" onclick="handleAuth()" class="btn w-2/3 pixel-font bg-red-950 border-red-700 text-red-500">INITIATE</button>
            </div>
        </div>
    </div>

    <!-- 3. ALL CLEAR -->
    <div id="win-screen" class="overlay-screen hidden">
        <h1 class="text-green-500 pixel-font text-2xl mb-4 flicker">ALL CLEAR</h1>
        <p class="text-zinc-500 text-[10px] mb-8 pixel-font">MISSION ACCOMPLISHED</p>
        <div class="bg-black border border-green-900 p-6 mb-8 w-full max-w-xs">
            <p id="win-score" class="pixel-font text-lg text-yellow-500 mb-2">SCORE: 0</p>
        </div>
        <button onclick="retreatToMenu()" class="btn w-full max-w-xs py-4 pixel-font">RETURN TO BASE</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="overlay-screen hidden">
        <h2 class="pixel-font text-red-700 text-2xl mb-6 flicker uppercase">You are dead.</h2>
        <p id="final-score-display" class="pixel-font text-[10px] text-zinc-500 mb-8"></p>
        <div class="flex flex-col gap-3 w-full max-w-xs">
            <button onclick="restartCurrentGame()" class="btn w-full py-4 pixel-font bg-red-950 text-red-500 border-red-700">RETRY</button>
            <button onclick="retreatToMenu()" class="btn w-full py-4 pixel-font">GIVE UP</button>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="admin-screen" class="overlay-screen hidden">
        <h2 class="pixel-font text-blue-600 mb-6">RECORDS MANAGEMENT</h2>
        <div class="admin-table-container">
            <table class="w-full text-[9px] text-left">
                <thead class="bg-zinc-900 text-zinc-400 font-bold uppercase sticky top-0">
                    <tr>
                        <th class="p-3">Class</th>
                        <th class="p-3">No</th>
                        <th class="p-3">Name</th>
                        <th class="p-3">Score</th>
                        <th class="p-3">Diff</th>
                    </tr>
                </thead>
                <tbody id="records-body"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" class="btn mt-8 py-3 px-12 pixel-font bg-blue-950 border-blue-700">LOGOUT TERMINAL</button>
    </div>

    <!-- Pause Screen -->
    <div id="pause-screen" class="overlay-screen hidden">
        <h2 class="pixel-font text-zinc-500 text-xl mb-4">PAUSED</h2>
        <div id="target-word-hint" class="text-xl text-white font-bold mb-10 border-y border-zinc-800 py-6 w-full px-4 text-center">---</div>
        <div class="flex flex-col gap-4 w-full max-w-xs px-4">
            <button onclick="speakTarget()" class="btn bg-blue-900 py-4 pixel-font">PLAY VOICE</button>
            <button onclick="resumeGame()" class="btn bg-green-950 py-4 pixel-font">RESUME</button>
        </div>
    </div>

    <!-- 遊戲畫布容器 -->
    <div class="canvas-container">
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- 下方 UI Panel -->
    <div class="ui-panel">
        <div class="flex justify-between items-end border-b border-zinc-800 pb-2">
            <div class="flex flex-col">
                <div id="status-label" class="pixel-font status-fine">FINE</div>
                <div id="score-display" class="text-[8px] text-zinc-600 pixel-font mt-1">000000</div>
            </div>
            <div id="level-progress-ui" class="text-[7px] text-zinc-700 pixel-font mb-1">SEC 1: 0/10</div>
        </div>

        <div class="flex items-center justify-center">
            <div id="current-word-ui" class="text-sm md:text-lg text-zinc-300 font-bold text-center leading-tight uppercase tracking-widest">---</div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="togglePause()" class="btn pixel-font !py-3">PAUSE</button>
            <button onclick="retreatToMenu()" class="btn pixel-font !py-3 bg-zinc-900">RETREAT</button>
        </div>
    </div>

    <div id="blood-splatter" class="fixed inset-0 pointer-events-none bg-red-900/30 opacity-0 transition-opacity duration-300 z-[150]"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKiz17S_mjAEcat-oT0EDVnvKxhTzxQe8",
        authDomain: "voiceofthedead.firebaseapp.com",
        projectId: "voiceofthedead",
        storageBucket: "voiceofthedead.firebasestorage.app",
        messagingSenderId: "757378314086",
        appId: "1:757378314086:web:aa598f79e28e3cb6a122a7"
    };

    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        window.fbase = { db, auth, setDoc, doc, collection, serverTimestamp, getDocs };
        signInAnonymously(auth);
    } catch (e) { console.error(e); }
    window.appId = 'voice-shooter-101';
</script>

<script>
    const ADMIN_NAME = "AdaWong";
    // 預設為 Book 4, Lesson 1
    let selectedBook = 4; 
    let selectedLesson = 1; 
    let currentBookData = {}; 
    let currentLessonData = null; 

    async function loadBookData(bookNum) {
        const statusEl = document.getElementById('mission-status');
        const btn = document.getElementById('confirm-mission-btn');
        statusEl.innerText = `ACCESSING ARCHIVE ${bookNum}...`;
        try {
            const response = await fetch(`book${bookNum}.json`);
            if (!response.ok) throw new Error();
            currentBookData = await response.json();
            statusEl.innerText = `ARCHIVE ${bookNum} READY`;
            checkDataAvailability();
        } catch (error) {
            currentBookData = {}; 
            statusEl.innerText = `ACCESS DENIED`;
            checkDataAvailability();
        }
    }

    function selectBook(n) {
        selectedBook = n;
        document.querySelectorAll('.book-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`b${n}`).classList.add('active-diff');
        loadBookData(n);
    }

    function selectLesson(n) {
        selectedLesson = n;
        document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`l${n}`).classList.add('active-diff');
        checkDataAvailability();
    }

    function checkDataAvailability() {
        const key = `L${selectedLesson}`;
        const statusEl = document.getElementById('mission-status');
        const btn = document.getElementById('confirm-mission-btn');
        if (currentBookData && currentBookData[key]) {
            statusEl.innerText = `READY: ${currentBookData[key].title.toUpperCase()}`;
            btn.disabled = false;
        } else {
            btn.disabled = true;
            statusEl.innerText = "NO DATA FOUND";
        }
    }

    // 初始化載入 Book 4
    loadBookData(4);

    function confirmMission() {
        const key = `L${selectedLesson}`;
        currentLessonData = currentBookData[key];
        document.getElementById('mission-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('selected-mission-title').innerText = currentLessonData.title.toUpperCase();
    }

    function backToMissionSelect() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('mission-screen').classList.remove('hidden');
    }

    function retreatToMenu() {
        state.gameActive = false;
        if (recognition) recognition.stop();
        document.getElementById('win-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('pause-screen').classList.add('hidden');
        document.getElementById('mission-screen').classList.remove('hidden');
    }

    function restartCurrentGame() {
        document.getElementById('game-over-screen').classList.add('hidden');
        startGame();
    }

    // --- Core Game Logic ---
    const LEVEL_GOALS = { 1: 10, 2: 5 }; 
    let state = {
        score: 0, hp: 5, level: 1, levelKills: 0, 
        difficultyMultiplier: 1.0, difficultyName: "Veteran",
        isPaused: false, gameActive: false,
        enemies: [], player: { class: "", no: "", name: "" },
        spawnTimer: 0, isFirstSpawn: true
    };

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const bloodOverlay = document.getElementById('blood-splatter');
    const mainContainer = document.getElementById('main-container');

    function handleResize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', handleResize);
    handleResize();

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        recognition.onresult = (event) => {
            if (state.isPaused || !state.gameActive) return;
            let transcript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript.toUpperCase();
            }
            state.enemies.forEach((enemy, index) => {
                if (!enemy.isDying) {
                    const cleanWord = enemy.word.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toUpperCase();
                    if (transcript.includes(cleanWord)) killEnemy(index);
                }
            });
        };
        recognition.onend = () => { if (state.gameActive && !state.isPaused) try { recognition.start(); } catch(e) {} };
    }

    class Enemy {
        constructor(word, lv, isElite = false, forceClose = false) {
            this.word = word;
            this.z = forceClose ? 0.3 : 0; 
            const stageFactor = state.level === 2 ? 0.8 : 1.1; 
            this.speed = (0.0008 + (Math.random() * 0.0006)) * state.difficultyMultiplier * (isElite ? 0.9 : 1) * stageFactor;
            
            // 隨機生成 X 座標，並在 spawnLogic 中確保不會太擠
            this.x = (Math.random() - 0.5) * 320; 
            this.y = (Math.random() - 0.5) * 60;
            
            this.isDying = false;
            this.opacity = 0;
            this.isElite = isElite;
            this.cSkin = isElite ? '#4a008b' : (Math.random() > 0.5 ? '#3d5c31' : '#567d46');
            this.cShirt = isElite ? 'gold' : (Math.random() > 0.5 ? '#4a4a4a' : '#2e2e2e');
        }

        update() {
            if (this.isDying) return (this.opacity -= 0.15) <= 0;
            this.z += this.speed;
            if (this.opacity < 1) this.opacity += 0.1;
            return this.z >= 1;
        }

        draw() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const w = rect.width;
            const h = rect.height;
            
            const size = (this.isElite ? 15 : 8) + (Math.pow(this.z, 2) * 220);
            const xPos = w / 2 + (this.x * this.z);
            const yPos = h / 2 + (this.y * this.z) + (this.z * (h * 0.3));
            
            ctx.save();
            ctx.globalAlpha = this.opacity;
            const br = 0.3 + (this.z * 0.7);
            ctx.filter = `brightness(${br})`;
            
            // 軀幹
            ctx.fillStyle = this.cShirt;
            ctx.fillRect(xPos - size*0.3, yPos - size*0.7, size*0.6, size*0.6); 

            // 頭部
            ctx.fillStyle = this.cSkin;
            ctx.fillRect(xPos - size*0.2, yPos - size*1.1, size*0.4, size*0.4); 
            
            // 眼睛
            ctx.fillStyle = this.isElite ? 'cyan' : 'red';
            ctx.fillRect(xPos - size*0.12, yPos - size*1.0, size*0.06, size*0.06);
            ctx.fillRect(xPos + size*0.06, yPos - size*1.0, size*0.06, size*0.06);

            const fontSize = Math.max(10, size/7.5);
            ctx.fillStyle = this.isElite ? 'gold' : '#fff';
            ctx.font = `bold ${fontSize}px 'Noto Sans TC'`;
            ctx.textAlign = 'center';
            ctx.shadowBlur = 4; ctx.shadowColor = 'red';
            ctx.fillText(this.word, xPos, yPos - size*1.3);
            
            ctx.restore();
        }
    }

    function setDifficulty(val, name) {
        state.difficultyMultiplier = val;
        state.difficultyName = name;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active-diff'));
        if (val === 0.7) document.getElementById('diff-rookie').classList.add('active-diff');
        if (val === 1.0) document.getElementById('diff-veteran').classList.add('active-diff');
        if (val === 1.5) document.getElementById('diff-nightmare').classList.add('active-diff');
        if (val === 2.5) document.getElementById('diff-nohope').classList.add('active-diff');
    }

    function spawnLogic() {
        if (!state.gameActive || state.isPaused) return;
        const interval = 1500 / state.difficultyMultiplier;
        if ((state.isFirstSpawn && state.enemies.length === 0) || (state.enemies.length < 4 && Date.now() - state.spawnTimer > interval)) {
            const list = currentLessonData.stages[state.level.toString()];
            if (!list) return;
            const word = list[Math.floor(Math.random() * list.length)];
            
            // 檢查是否重複
            if (!state.enemies.some(e => e.word === word)) {
                let newEnemy = new Enemy(word, state.level, Math.random() < 0.15, state.isFirstSpawn);
                
                // 分散邏輯：如果離現有敵人太近，嘗試調整 X 座標 (最多嘗試 5 次)
                let attempts = 0;
                while (attempts < 5 && state.enemies.some(e => Math.abs(e.x - newEnemy.x) < 50)) {
                    newEnemy.x = (Math.random() - 0.5) * 320;
                    attempts++;
                }

                state.enemies.push(newEnemy);
                state.spawnTimer = Date.now();
                state.isFirstSpawn = false;
            }
        }
    }

    function killEnemy(idx) {
        if (!state.enemies[idx]) return;
        state.enemies[idx].isDying = true;
        state.score += (state.enemies[idx].isElite ? 500 : 100) * state.level;
        state.levelKills++;
        document.getElementById('current-word-ui').innerText = state.enemies[idx].word.toUpperCase();
        if (state.levelKills >= LEVEL_GOALS[state.level]) {
            if (state.level < 2) { state.level++; state.levelKills = 0; state.enemies = []; }
            else { winGame(); }
        }
        updateUI();
    }

    function triggerDamage() {
        state.hp--; bloodOverlay.style.opacity = "1";
        mainContainer.classList.add('shake-anim');
        setTimeout(() => { bloodOverlay.style.opacity = "0"; mainContainer.classList.remove('shake-anim'); }, 300);
        updateUI(); if (state.hp <= 0) endGame();
    }

    function updateUI() {
        const statusLabel = document.getElementById('status-label');
        if (state.hp >= 5) { statusLabel.innerText = "FINE"; statusLabel.className = "pixel-font status-fine"; }
        else if (state.hp >= 3) { statusLabel.innerText = "CAUTION"; statusLabel.className = "pixel-font status-caution"; }
        else { statusLabel.innerText = "DANGER"; statusLabel.className = "pixel-font status-danger"; }

        document.getElementById('score-display').innerText = state.score.toString().padStart(6, '0');
        document.getElementById('level-progress-ui').innerText = `SEC ${state.level}: ${state.levelKills}/${LEVEL_GOALS[state.level]}`;
    }

    function gameLoop() {
        if (!state.gameActive || state.isPaused) return;
        const rect = canvas.parentElement.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
        
        ctx.strokeStyle = '#080808'; ctx.lineWidth = 1; ctx.beginPath();
        for(let i=0; i<8; i++) {
            ctx.moveTo(w/2, h/2); ctx.lineTo(i * (w/7), h);
        }
        ctx.stroke();

        spawnLogic();
        state.enemies.sort((a, b) => a.z - b.z);
        for (let i = state.enemies.length - 1; i >= 0; i--) {
            const enemy = state.enemies[i];
            if (enemy.update()) {
                if (!enemy.isDying) { state.enemies.splice(i, 1); triggerDamage(); }
                else { state.enemies.splice(i, 1); }
            } else { enemy.draw(); }
        }
        requestAnimationFrame(gameLoop);
    }

    function handleAuth() {
        const grade = document.getElementById('select-grade').value;
        const cls = document.getElementById('select-class').value;
        const no = document.getElementById('input-no').value.trim();
        const name = document.getElementById('input-name').value.trim();
        
        // 輸入 AdaWong 進入後台
        if (name === ADMIN_NAME) { 
            showAdminDashboard(); 
            return; 
        }
        
        if (!no || !name) return;
        state.player = { class: `${grade}${cls}`, no: no, name: name };
        document.getElementById('login-screen').classList.add('hidden');
        startGame();
    }

    async function showAdminDashboard() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-screen').classList.remove('hidden');
        const body = document.getElementById('records-body');
        body.innerHTML = "<tr><td colspan='5' class='p-8 text-center animate-pulse'>CONNECTING TO DATABASE...</td></tr>";
        try {
            const { db, appId, collection, getDocs } = window.fbase;
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
            let res = []; snap.forEach(d => res.push(d.data()));
            
            // 排序：班級 -> 座號
            res.sort((a,b) => a.class.localeCompare(b.class) || a.no - b.no);
            
            body.innerHTML = "";
            if (res.length === 0) {
                body.innerHTML = "<tr><td colspan='5' class='p-8 text-center text-zinc-600'>NO RECORDS FOUND</td></tr>";
            } else {
                res.forEach(d => {
                    body.insertAdjacentHTML('beforeend', `
                        <tr class="border-b border-zinc-900 hover:bg-zinc-950">
                            <td class="p-3 text-zinc-300 font-bold">${d.class}</td>
                            <td class="p-3 text-zinc-500">${d.no}</td>
                            <td class="p-3 text-white">${d.name}</td>
                            <td class="p-3 text-green-500 font-bold">${d.score}</td>
                            <td class="p-3 text-zinc-600 text-[7px]">${d.difficulty || 'N/A'}</td>
                        </tr>
                    `);
                });
            }
        } catch (e) { body.innerHTML = "<tr><td colspan='5' class='p-8 text-center text-red-700'>CRITICAL ERROR: CONNECTION REFUSED</td></tr>"; }
    }

    function startGame() {
        state.gameActive = true; state.hp = 5; state.score = 0; state.level = 1; state.levelKills = 0; state.enemies = []; state.isFirstSpawn = true;
        updateUI(); 
        handleResize(); 
        if (recognition) { try { recognition.start(); } catch(e) {} } 
        gameLoop();
    }

    async function syncData() {
        try {
            const { db, appId, setDoc, doc, serverTimestamp } = window.fbase;
            const rid = `${state.player.class}_${state.player.no}_${Date.now()}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', rid), {
                ...state.player, 
                score: state.score, 
                difficulty: state.difficultyName,
                timestamp: serverTimestamp()
            });
        } catch (e) {}
    }

    function winGame() { state.gameActive = false; document.getElementById('win-screen').classList.remove('hidden'); document.getElementById('win-score').innerText = `SCORE: ${state.score}`; syncData(); }
    function endGame() { state.gameActive = false; document.getElementById('game-over-screen').classList.remove('hidden'); document.getElementById('final-score-display').innerText = `SCORE: ${state.score}`; syncData(); }
    
    function togglePause() { 
        if (!state.gameActive) return;
        state.isPaused = !state.isPaused; 
        document.getElementById('pause-screen').classList.toggle('hidden');
        if (state.isPaused) { if (recognition) recognition.stop(); if (state.enemies[0]) document.getElementById('target-word-hint').innerText = state.enemies[0].word.toUpperCase(); }
        else { if (recognition) try { recognition.start(); } catch(e) {} gameLoop(); }
    }
    function resumeGame() { togglePause(); }
    function speakTarget() { const u = new SpeechSynthesisUtterance(document.getElementById('target-word-hint').innerText); u.lang = 'en-US'; speechSynthesis.speak(u); }
</script>
</body>
</html>
